<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Plan Your Trip - Coastal Guide</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=container-queries,forms"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1193d4",
              "background-light": "#f6f7f8",
              "background-dark": "#101c22",
              "surface-light": "#ffffff",
              "surface-dark": "#1a2831",
              "text-light": "#101c22",
              "text-dark": "#f6f7f8",
              "text-muted-light": "#6b7280",
              "text-muted-dark": "#9ca3af",
              "border-light": "#e5e7eb",
              "border-dark": "#374151",
            },
            fontFamily: {
              display: ["Plus Jakarta Sans", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "1rem",
              xl: "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      .dark .dark-mode-icon-light {
        display: none;
      }
      .dark-mode-icon-dark {
        display: none;
      }
      .dark .dark-mode-icon-dark {
        display: inline-block;
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
    </style>
  </head>
  <body
    class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark"
  >
    <div class="relative w-full overflow-x-hidden">
      <header
        class="w-full bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm sticky top-0 z-50"
      >
        <nav
          class="container mx-auto px-6 py-3 flex items-center justify-between"
        >
          <div class="flex items-center gap-8">
            <a
              class="flex items-center gap-3 text-slate-900 dark:text-white"
              href="index.html"
            >
              <svg
                class="h-8 w-8 text-primary"
                fill="none"
                viewBox="0 0 48 48"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z"
                  fill="currentColor"
                ></path>
              </svg>
              <span class="text-xl font-bold">Coastal Guide</span>
            </a>
            <div id="nav-menu" class="hidden md:flex items-center gap-8">
              <a
                class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors"
                href="searchbeach.html"
                >Beaches</a
              >
              <a
                class="text-sm font-medium text-text-light dark:text-text-dark hover:text-primary transition-colors"
                href="plantrip.html"
                >Plan a Trip</a
              >
              <a
                class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors"
                href="alert.html"
                >Safety</a
              >
              <a
                class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors"
                href="index.html#about-section"
                >About</a
              >
            </div>
          </div>
          <div class="flex items-center gap-4">
            <button
              id="dark-mode-toggle"
              class="p-2 rounded-full hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors"
            >
              <span class="material-symbols-outlined dark-mode-icon-light"
                >light_mode</span
              >
              <span class="material-symbols-outlined dark-mode-icon-dark"
                >dark_mode</span
              >
            </button>
            <div id="guest-menu" class="items-center gap-4">
              <a
                href="login.html"
                class="bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary font-bold text-sm px-5 py-2.5 rounded-full hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors"
                >Login</a
              >
              <a
                href="registration.html"
                class="bg-primary text-white font-bold text-sm px-5 py-2.5 rounded-full hover:bg-primary/90 transition-colors shadow-md"
                >Sign Up</a
              >
            </div>
            <div id="user-profile" class="relative items-center gap-4">
              <!-- User menu will be populated by auth.js -->
            </div>
            <button
              id="mobile-menu-button"
              class="md:hidden p-2 rounded-full text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors"
            >
              <span class="material-symbols-outlined">menu</span>
            </button>
          </div>
        </nav>
      </header>

      <main class="flex-grow">
        <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 py-12">
          <div class="mb-12 text-center">
            <h2
              class="text-4xl font-extrabold tracking-tight text-background-dark dark:text-background-light sm:text-5xl"
            >
              Plan Your Perfect Beach Trip
            </h2>
            <p
              class="mt-4 text-lg text-background-dark/70 dark:text-background-light/70"
            >
              Select a beach, date, and time to get personalized safety advice
              and hotel recommendations.
            </p>
          </div>

          <!-- Planning Form -->
          <div
            class="bg-surface-light dark:bg-surface-dark p-8 rounded-xl shadow-lg mb-12"
          >
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label
                  for="beach-select"
                  class="block text-sm font-medium text-text-light dark:text-text-dark"
                  >Select a Beach</label
                >
                <div class="relative">
                  <input
                    type="text"
                    id="beach-input"
                    list="beach-list-options"
                    placeholder="Type or select a beach"
                    class="mt-1 block w-full rounded-md border-border-light dark:border-border-dark shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-background-dark"
                  />
                  <datalist id="beach-list-options">
                    <!-- Options will be populated by JS -->
                  </datalist>
                  <input type="hidden" id="beach-select-id" />
                  <input type="hidden" id="beach-select-lat" />
                  <input type="hidden" id="beach-select-lon" />
                </div>
              </div>
              <div>
                <label
                  for="trip-date"
                  class="block text-sm font-medium text-text-light dark:text-text-dark"
                  >Date</label
                >
                <input
                  type="date"
                  name="trip-date"
                  id="trip-date"
                  class="mt-1 block w-full rounded-md border-border-light dark:border-border-dark shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-background-dark"
                />
              </div>
              <div>
                <label
                  for="trip-time"
                  class="block text-sm font-medium text-text-light dark:text-text-dark"
                  >Time</label
                >
                <input
                  type="time"
                  name="trip-time"
                  id="trip-time"
                  class="mt-1 block w-full rounded-md border-border-light dark:border-border-dark shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-background-dark"
                />
              </div>
            </div>
            <div class="mt-6 text-center">
              <button
                id="plan-trip-btn"
                class="bg-primary text-white font-bold text-base px-8 py-3 rounded-full hover:bg-primary/90 transition-all transform hover:scale-105 shadow-lg"
              >
                <span class="material-symbols-outlined align-middle mr-2"
                  >travel_explore</span
                >
                Check Conditions
              </button>
            </div>
          </div>

          <!-- Results Section -->
          <div id="trip-results" class="hidden space-y-12">
            <!-- Recommendation Section -->
            <div id="recommendation-section">
              <h3 class="text-2xl font-bold mb-4">Trip Recommendation</h3>
              <div id="recommendation-card" class="p-6 rounded-lg border">
                <!-- Recommendation content here -->
              </div>
              <div id="save-trip-section" class="mt-6 text-center hidden">
                <button
                  id="save-trip-btn"
                  class="bg-green-600 text-white font-bold text-base px-8 py-3 rounded-full hover:bg-green-700 transition-all transform hover:scale-105 shadow-lg"
                >
                  <span class="material-symbols-outlined align-middle mr-2"
                    >favorite</span
                  >
                  Save This Trip
                </button>
              </div>
            </div>

            <!-- Nearby Hotels Section -->
            <div id="nearby-section">
              <h3 class="text-2xl font-bold mb-4">
                Nearby Hotels & Restaurants
              </h3>
              <div id="nearby-places-container" class="space-y-6">
                <!-- Hotels will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer class="bg-white dark:bg-slate-900/50 mt-12">
        <div class="container mx-auto px-6 py-12">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div>
              <a
                class="flex items-center gap-3 text-slate-900 dark:text-white"
                href="index.html"
              >
                <svg
                  class="h-8 w-8 text-primary"
                  fill="none"
                  viewBox="0 0 48 48"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z"
                    fill="currentColor"
                  ></path>
                </svg>
                <span class="text-xl font-bold">Coastal Guide</span>
              </a>
              <p
                class="mt-4 text-sm text-text-muted-light dark:text-text-muted-dark"
              >
                Your guide to the best beaches in India, with real-time safety
                and activity information.
              </p>
            </div>
            <div>
              <h3
                class="text-lg font-bold text-text-light dark:text-text-dark mb-4"
              >
                Quick Links
              </h3>
              <ul class="space-y-2">
                <li>
                  <a
                    class="text-sm text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors"
                    href="searchbeach.html"
                    >Beaches</a
                  >
                </li>
                <li>
                  <a
                    class="text-sm text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors"
                    href="plantrip.html"
                    >Plan a Trip</a
                  >
                </li>
                <li>
                  <a
                    class="text-sm text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors"
                    href="alert.html"
                    >Safety Alerts</a
                  >
                </li>
                <li>
                  <a
                    class="text-sm text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors"
                    href="index.html#about-section"
                    >About Us</a
                  >
                </li>
              </ul>
            </div>
            <div class="lg:col-span-2">
              <h3
                class="text-lg font-bold text-text-light dark:text-text-dark mb-4"
              >
                Newsletter
              </h3>
              <p
                class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4"
              >
                Stay updated with our latest news and offers.
              </p>
              <form class="flex flex-col sm:flex-row gap-2">
                <input
                  class="flex-grow bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-md px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                  placeholder="Enter your email"
                  type="email"
                />
                <button
                  class="px-4 py-2 bg-primary text-white rounded-md text-sm font-semibold hover:bg-primary/90 transition-colors"
                  type="submit"
                >
                  Subscribe
                </button>
              </form>
            </div>
          </div>
          <div
            class="border-t border-border-light dark:border-border-dark mt-8 pt-8 text-center text-sm text-text-muted-light dark:text-text-muted-dark"
          >
            <p>© 2025 Coastal Guide by Vinod Kumar. All rights reserved.</p>
          </div>
        </div>
      </footer>
    </div>

    <script type="module">
      import { beaches } from "./assets/js/beaches.js";
      import { app } from "./assets/js/firebase-init.js";
      import {
        OPENWEATHER_API_KEY,
        WORLDTIDES_API_KEY,
      } from "./assets/js/config.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      window.__COASTAL_CONFIG__ = { OPENWEATHER_API_KEY, WORLDTIDES_API_KEY };
      import "./weather.js";
      import { sendImmediateTripNotification } from "./assets/js/auth.js";
      import { NearbyPlacesManager } from "./assets/js/nearby-places.js";

      document.addEventListener("DOMContentLoaded", () => {
        const auth = getAuth(app);
        const db = getFirestore(app);

        const beachDatalist = document.getElementById("beach-list-options");
        const planTripBtn = document.getElementById("plan-trip-btn");
        const tripResults = document.getElementById("trip-results");
        const recommendationCard = document.getElementById(
          "recommendation-card"
        );
        const nearbyContainer = document.getElementById(
          "nearby-places-container"
        );
        const dateInput = document.getElementById("trip-date");
        const timeInput = document.getElementById("trip-time");

        const saveTripSection = document.getElementById("save-trip-section");
        const saveTripBtn = document.getElementById("save-trip-btn");

        let currentTripData = {};

        const beachInput = document.getElementById("beach-input");
        const beachIdInput = document.getElementById("beach-select-id");
        const beachLatInput = document.getElementById("beach-select-lat");
        const beachLonInput = document.getElementById("beach-select-lon");

        // Populate beaches
        beachDatalist.innerHTML = "";
        beaches.beaches_in_india.forEach((beach) => {
          const option = document.createElement("option");
          option.value = `${beach.name}, ${beach.state_ut}`;
          option.dataset.id = beach.id;
          option.dataset.lat = beach.lat;
          option.dataset.lon = beach.lon;
          beachDatalist.appendChild(option);
        });

        beachInput.addEventListener("input", (e) => {
          const value = e.target.value;
          const option = Array.from(beachDatalist.options).find(
            (opt) => opt.value === value
          );
          if (option) {
            beachIdInput.value = option.dataset.id;
            beachLatInput.value = option.dataset.lat;
            beachLonInput.value = option.dataset.lon;
          } else {
            beachIdInput.value = "";
            beachLatInput.value = "";
            beachLonInput.value = "";
          }
        });

        // Check for reschedule parameters in URL
        const urlParams = new URLSearchParams(window.location.search);
        const beachToRescheduleId = urlParams.get("beachId");
        const beachToRescheduleName = urlParams.get("beachName");

        if (beachToRescheduleId && beachToRescheduleName) {
          beachInput.value = beachToRescheduleName;
          const option = Array.from(beachDatalist.options).find(
            (opt) => opt.dataset.id === beachToRescheduleId
          );
          if (option) {
            beachIdInput.value = option.dataset.id;
            beachLatInput.value = option.dataset.lat;
            beachLonInput.value = option.dataset.lon;
            planTripBtn.scrollIntoView({ behavior: "smooth" });
          }
        }

        // Set default date and time
        const now = new Date();
        dateInput.value = now.toISOString().split("T")[0];
        timeInput.value = now.toTimeString().substring(0, 5);

        planTripBtn.addEventListener("click", async () => {
          const tripDateStr = dateInput.value;
          const tripTimeStr = timeInput.value;
          const tripDateTime = new Date(`${tripDateStr}T${tripTimeStr}`);
          const now = new Date();
          saveTripSection.classList.add("hidden");

          if (tripDateTime < now) {
            tripResults.classList.remove("hidden");
            recommendationCard.innerHTML = `<h4 class="font-bold text-lg mb-2 flex items-center gap-2"><span class="material-symbols-outlined">error</span>Invalid Date</h4><p>Please select a future date and time for your trip plan.</p>`;
            recommendationCard.className =
              "p-6 rounded-lg border border-yellow-500/50 bg-yellow-500/10 text-yellow-700 dark:text-yellow-300";
            document.getElementById("nearby-section").classList.add("hidden");
            return;
          }

          if (!beachIdInput.value) {
            alert("Please select a beach.");
            return;
          }

          const lat = beachLatInput.value;
          const lon = beachLonInput.value;
          const beachName = beachInput.value;

          tripResults.classList.remove("hidden");
          document.getElementById("nearby-section").classList.remove("hidden");
          recommendationCard.innerHTML = `<div class="text-center"><span class="material-symbols-outlined animate-spin">refresh</span> Checking conditions...</div>`;
          nearbyContainer.innerHTML = `<div class="text-center"><span class="material-symbols-outlined animate-spin">refresh</span> Finding hotels...</div>`;

          // Fetch weather and generate recommendation
          const forecast = await fetchForecast(lat, lon, tripDateTime);
          displayRecommendation(forecast, tripDateTime);

          currentTripData = {
            beachId: beachIdInput.value,
            beachName: beachName,
            beachLat: lat,
            beachLon: lon,
            tripDate: Timestamp.fromDate(tripDateTime),
            hotel: null,
            status: "planned",
            createdAt: serverTimestamp(),
          };

          // Fetch nearby places
          const nearbyManager = new NearbyPlacesManager();
          nearbyManager.currentLocation = {
            lat: parseFloat(lat),
            lon: parseFloat(lon),
            name: beachName,
          };
          const places = await nearbyManager.fetchNearbyPlaces();
          nearbyManager.places = places;
          nearbyManager.renderNearbyPlaces(
            "#nearby-places-container",
            (place) => {
              currentTripData.hotel = place;
              // Visually indicate selection
              document
                .querySelectorAll("#nearby-places-container .place-card")
                .forEach((card) =>
                  card.classList.remove("ring-2", "ring-primary")
                );
              const cardEl = document.getElementById(`place-card-${place.id}`);
              if (cardEl) cardEl.classList.add("ring-2", "ring-primary");
            }
          );

          onAuthStateChanged(auth, (user) => {
            if (user) {
              saveTripSection.classList.remove("hidden");
            }
          });
        });

        saveTripBtn.addEventListener("click", async () => {
          const user = auth.currentUser;
          if (!user) {
            alert("Please log in to save your trip.");
            return;
          }
          saveTripBtn.disabled = true;
          saveTripBtn.innerHTML = `<span class="material-symbols-outlined animate-spin align-middle mr-2">sync</span> Saving...`;
          await addDoc(
            collection(db, "users", user.uid, "trips"),
            currentTripData
          );

          // Check if the saved trip is for today and trigger notification
          const tripDate = currentTripData.tripDate.toDate();
          const today = new Date();
          if (
            tripDate.getFullYear() === today.getFullYear() &&
            tripDate.getMonth() === today.getMonth() &&
            tripDate.getDate() === today.getDate()
          ) {
            sendImmediateTripNotification(user, currentTripData);
          }

          saveTripBtn.innerHTML = `<span class="material-symbols-outlined align-middle mr-2">check_circle</span> Saved!`;
          setTimeout(() => {
            saveTripBtn.disabled = false;
            saveTripBtn.innerHTML = `<span class="material-symbols-outlined align-middle mr-2">favorite</span> Save This Trip`;
          }, 2000);
        });

        async function fetchForecast(lat, lon, targetDate) {
          const apiKey = window.__COASTAL_CONFIG__.OPENWEATHER_API_KEY;
          if (!apiKey) return null;
          try {
            const response = await fetch(
              `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`
            );
            if (!response.ok) {
              console.error(
                "Forecast API request failed:",
                response.statusText
              );
              return null;
            }
            const forecastData = await response.json();

            // Find the closest forecast to the target date
            const targetTimestamp = targetDate.getTime() / 1000;
            let closestForecast = null;
            let minDiff = Infinity;

            for (const forecast of forecastData.list) {
              const diff = Math.abs(forecast.dt - targetTimestamp);
              if (diff < minDiff) {
                minDiff = diff;
                closestForecast = forecast;
              }
            }
            return closestForecast;
          } catch (error) {
            console.error("Failed to fetch forecast", error);
            return null;
          }
        }

        function displayRecommendation(forecast, tripDate) {
          if (!forecast) {
            recommendationCard.innerHTML = `
                    <h4 class="font-bold text-lg mb-2 flex items-center gap-2"><span class="material-symbols-outlined">cloud_off</span>Unavailable</h4>
                    <p>Could not fetch forecast data for the selected date. It might be too far in the future. Please try a date within the next 5 days.</p>`;
            recommendationCard.className =
              "p-6 rounded-lg border border-red-500/50 bg-red-500/10 text-red-700 dark:text-red-300";
            return;
          }

          const windSpeed = forecast.wind.speed * 3.6; // to km/h
          const condition = forecast.weather[0].main;
          let advice = "";
          let safetyLevel = "Good";

          if (windSpeed > 30) {
            advice +=
              "High winds are expected. Be cautious with water sports. ";
            safetyLevel = "Poor";
          }
          if (["Thunderstorm", "Rain", "Squall"].includes(condition)) {
            advice +=
              "Bad weather is expected. It is not safe to visit the beach. ";
            safetyLevel = "Poor";
          }
          if (windSpeed > 15) {
            advice += "Winds are a bit strong. Be careful if swimming. ";
            if (safetyLevel !== "Poor") safetyLevel = "Moderate";
          }

          if (!advice) {
            advice =
              "Conditions look great for a beach visit! Enjoy your trip.";
          }

          const colors = {
            Good: "border-green-500/50 bg-green-500/10 text-green-700 dark:text-green-300",
            Moderate:
              "border-yellow-500/50 bg-yellow-500/10 text-yellow-700 dark:text-yellow-300",
            Poor: "border-red-500/50 bg-red-500/10 text-red-700 dark:text-red-300",
          };

          recommendationCard.className = `p-6 rounded-lg border ${colors[safetyLevel]}`;
          recommendationCard.innerHTML = `
                <h4 class="font-bold text-lg mb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined">${
                      safetyLevel === "Good"
                        ? "thumb_up"
                        : safetyLevel === "Moderate"
                        ? "warning"
                        : "dangerous"
                    }</span>
                    Recommendation: It's a ${safetyLevel} time to visit.
                </h4>
                <p>${advice}</p>
                <div class="mt-4 text-sm opacity-80">
                    <strong>Forecast for ${tripDate.toLocaleDateString([], {
                      weekday: "short",
                      month: "short",
                      day: "numeric",
                    })} at ${tripDate.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          })}:</strong><br/>
                    <strong>Weather:</strong> ${forecast.main.temp.toFixed(
                      1
                    )}°C, ${forecast.weather[0].description} | 
                    <strong>Wind:</strong> ${windSpeed.toFixed(1)} km/h
                </div>
            `;
        }
      });
    </script>
    <script>
      // Dark mode toggle
      (function () {
        const toggle = document.getElementById("dark-mode-toggle");
        if (!toggle) return;

        // Check for saved preference, or use system preference
        if (
          localStorage.theme === "dark" ||
          (!("theme" in localStorage) &&
            window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }

        toggle.addEventListener("click", () => {
          document.documentElement.classList.toggle("dark");
          localStorage.theme = document.documentElement.classList.contains(
            "dark"
          )
            ? "dark"
            : "light";
        });
      })();
    </script>
    <script src="assets/js/auth.js" type="module"></script>
  </body>
</html>
